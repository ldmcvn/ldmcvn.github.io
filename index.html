<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="content-language" content="vi">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="Luudan Matcuoi">
    <link rel="shortcut icon" href="/data/flavicon.png">
    <link defer rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style type="text/css">
        #sidebar-wrapper {
            background-color: #ffcfdf;
            margin-left: -9rem;
            transition: margin .25s ease-out;
        }
        
        #sidebar-wrapper .list-group {
            width: 9rem;
        }
        
        #wrapper.toggled #sidebar-wrapper {
            margin-left: 0;
        }
        
        .navbar {
            background-color: #a5dee5;
        }
        
        @media (min-width: 768px) {
            #sidebar-wrapper {
                margin-left: 0;
            }
            #wrapper.toggled #sidebar-wrapper {
                margin-left: -9rem;
            }
        }
        
        a {
            text-decoration: none !important;
        }
        
        .list-group-item {
            background-color: #ffcfdf;
            border: 1.5px solid #997C85;
        }
        
        .list-group-item:hover {
            background-color: #e0f9b5;
        }
        
        .footer {
            padding: 0.4em 0em;
            background-color: #494949;
            text-align: center;
            color: white;
            box-sizing: border-box;
            font-style: italic;
        }
        
        @font-face {
            font-family: 'icomoon';
            font-display: swap;
            src: url('/data/icomoon.eot');
            src: url('/data/icomoon.eot') format('embedded-opentype'),
                 url('/data/icomoon.ttf') format('truetype'),
                 url('/data/icomoon.woff') format('woff'),
                 url('/data/icomoon.svg') format('svg');
            font-weight: 400;
            font-style: normal;
            font-display: block;
        }
        
        [class*=" fa-"], [class^=fa-] {
            font-family: icomoon !important;
            speak: none;
            font-style: normal;
            font-weight: 400;
            font-variant: normal;
            text-transform: none;
            line-height: 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .fa-plus-circle:before { content: "\e900"; }
        .fa-th-large:before { content: "\e901"; }
        .fa-user-times:before { content: "\e902"; }
        .fa-address-card:before { content: "\e903"; }
        .fa-bars:before { content: "\e904"; }
        .fa-home:before { content: "\e905"; }
        .fa-list:before { content: "\e906"; }
        .fa-key:before { content: "\e907"; }
        .fa-book:before { content: "\e91f"; }
        .fa-folder:before { content: "\e92f"; }
        .fa-address-book:before { content: "\e944"; }
        
        textarea {
            width: 100%;
            outline: none;
            overflow: hidden;
        }
        
        div#body.darkside {
            background-color: #303030 !important;
        }
        
        textarea#newone.darkside {
            background-color: #474747 !important;
            color: #fff;
        }
        
        div.card.darkside {
            background-color: #474747 !important;
            color: #fff;
        }
        
        pre {
            font-family: OKkhong;
            font-size: 120%;
            overflow-x: auto;
            white-space: pre-wrap;
            white-space: -moz-pre-wrap;
            white-space: -pre-wrap;
            white-space: -o-pre-wrap;
            word-wrap: break-word;
        }
        
        .auth-form {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 2rem;
            margin: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #loading-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            z-index: 9999;
        }
    </style>

    <title>MONOSA</title>
</head>

<body>
    <div id="loading-view">
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading...</div>
        </div>
    </div>

    <div id="auth-view" style="display: none;">
        <div class="d-flex flex-column" style="min-height: 100vh; background-color: #fefdca;">
            <nav class="navbar">
                <div class="lead mx-auto" style="font-size: 1.75rem; letter-spacing: 10px;">
                    <a href="javascript:void(0)">MONOSA</a>
                </div>
            </nav>
            
            <div class="container-fluid flex-grow-1 d-flex justify-content-center align-items-center">
                <div class="row w-100 justify-content-center">
                    <div class="col-md-6">
                        <div class="auth-form">
                            <h2 id="signup-login-title" class="text-center mb-4">Login</h2>

                            <form id="signup-form" style="display:none">
                                <div class="mb-3">
                                    <input id="signup-email" type="email" class="form-control" required placeholder="Email">
                                </div>
                                <div class="mb-3">
                                    <input id="signup-password" type="password" class="form-control" required placeholder="Password">
                                </div>
                                <button type="submit" class="btn btn-success w-100">Create Account</button>
                            </form>

                            <form id="login-form">
                                <div class="mb-3">
                                    <input id="login-email" type="email" class="form-control" required placeholder="Email">
                                </div>
                                <div class="mb-3">
                                    <input id="login-password" type="password" class="form-control" required placeholder="Password">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Sign In</button>
                            </form>
                            <br>
                            <a href="javascript:void(0)" id="change-mode-button" class="btn btn-secondary w-100" mode="login">
                                You want to create account?
                            </a>
                            <div id="info-error" class="alert alert-danger mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-view" style="display: none;">
        <div class="d-flex flex-column" style="min-height: 100vh">
            <nav class="navbar">
                <button class="btn btn-secondary py-2" id="menu-toggle" aria-label="toggled-sidebar">
                    <i class="fa-address-card"></i> Hello <span id="username-display"></span>
                </button>
                <div class="lead mx-auto" style="font-size: 1.75rem; letter-spacing: 10px;">
                    <a href="javascript:void(0)">MONOSA</a>
                </div>
            </nav>
            
            <div class="d-flex flex-grow-1" id="wrapper">
                <div id="sidebar-wrapper">
                    <div class="list-group list-group-flush">
                        <a href="javascript:void(0)" id="diary-sidebar" class="list-group-item list-group-item-action">
                            <i class="fa-address-book"></i> Diary
                        </a>
                        <a href="javascript:void(0)" id="logout-button" class="list-group-item list-group-item-action">
                            Logout
                        </a>
                        <div class="list-group-item-action"></div>
                    </div>
                </div>
                
                <div id="body" class="flex-grow-1" style="background-color: #fefdca">
                     <div id="home-section" class="px-2">
                        <div class="container mt-4">
                            <h1>Hello Worlds</h1>
                        </div>
                    </div>

                    <div id="diary-section" class="px-2" style="display: none;">
                        <div id="db-loading" class="text-center mt-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading diaries...</span>
                            </div>
                            <div class="mt-2">Loading your diaries...</div>
                        </div>
                        <div id="db-error" class="alert alert-danger mt-3" style="display: none;"></div>
                        
                        <div id="diary-content" style="display: none;">
                            <p class="lead mt-3">&gt; New one ??? :)</p>
                            <textarea id="newone" class="border text-left form-control" placeholder="Dear diary" style="height: 130px;"></textarea>
                            <button id="add-diary-btn" class="btn btn-primary mt-3 w-100" type="button">Send</button>
                            <div id="add-diary-error" class="alert alert-danger mt-3" style="display: none;"></div>
                            
                            <hr>
                            <div id="diaries-list">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDTxxtuR4wjVdrnaYdkKxJvgC2uylcHZas",
            authDomain: "monosa-58cc6.firebaseapp.com",
            databaseURL: "https://monosa-58cc6.firebaseio.com",
            projectId: "monosa-58cc6",
            storageBucket: "monosa-58cc6.firebasestorage.app",
            messagingSenderId: "340674354766",
            appId: "1:340674354766:web:fa1e6d8f8bcbd5d3d56d1f"
        };
        // Initialize Firebase
        // const firebase = initializeApp(firebaseConfig);

        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let diaryUnsubscribe = null; // To detach the Firestore listener on logout

        // Listen for authentication state changes
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                showApp(user.email); // Use email to display username
            } else {
                currentUser = null;
                showAuth();
            }
            document.getElementById('loading-view').style.display = 'none';
        });

        // Authentication functions
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    const errorDiv = document.getElementById('info-error');
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                });
        }

        function handleSignUp(e) {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .catch((error) => {
                    const errorDiv = document.getElementById('info-error');
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                });
        }

        function handleLogout() {
            if (diaryUnsubscribe) {
                diaryUnsubscribe(); // Detach the real-time listener
            }
            auth.signOut().catch((e) => console.error('Logout error:', e));
        }

        function change_mode(e) {
            if (e.getAttribute("mode") === "login"){
                document.getElementById('signup-form').style.display = 'block';
                document.getElementById('login-form').style.display = 'none';
                e.setAttribute('mode','signup');
                document.getElementById('signup-login-title').innerHTML = 'Create Account';
                e.innerHTML = "Already have an account? Login";
            } else {
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('signup-form').style.display = 'none';
                e.setAttribute('mode','login');
                document.getElementById('signup-login-title').innerHTML = 'Login';
                e.innerHTML = "Don't have an account? Create one";
            }
        }

        function showApp(username) {
            document.getElementById('auth-view').style.display = 'none';
            document.getElementById('app-view').style.display = 'block';
            document.getElementById('username-display').textContent = username;
            showDiary();
        }

        function showDiary() {
            document.getElementById('home-section').style.display = 'none';
            document.getElementById('diary-section').style.display = 'block';
            initDiaryListener();
        }

        // View management functions
        function showAuth() {
            document.getElementById('auth-view').style.display = 'block';
            document.getElementById('app-view').style.display = 'none';
            
            // Clear form fields and errors
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('info-error').style.display = 'none';
            document.getElementById('signup-email').value = '';
            document.getElementById('signup-password').value = '';
        }

        // Diary database functions
        function initDiaryListener() {
            if (!currentUser) return;
            if (diaryUnsubscribe) diaryUnsubscribe(); // Detach any previous listener

            document.getElementById('db-loading').style.display = 'block';
            document.getElementById('diary-content').style.display = 'none';
            document.getElementById('db-error').style.display = 'none';
            
            const diaryCollection = db.collection('users').doc(currentUser.uid).collection('diaries');
            
            diaryUnsubscribe = diaryCollection.orderBy("timestamp", "desc").onSnapshot(snapshot => {
                document.getElementById('db-loading').style.display = 'none';
                document.getElementById('diary-content').style.display = 'block';
                renderDiaries(snapshot.docs);
            }, error => {
                document.getElementById('db-loading').style.display = 'none';
                const errorDiv = document.getElementById('db-error');
                errorDiv.textContent = 'Failed to load diary: ' + error.message;
                errorDiv.style.display = 'block';
            });
        }

        function renderDiaries(docs) {
            const diariesList = document.getElementById('diaries-list');
            
            if (docs.length === 0) {
                diariesList.innerHTML = '<p class="text-muted">No diary entries yet. Start writing!</p>';
                return;
            }
            
            diariesList.innerHTML = '';
            
            docs.forEach(doc => {
                const diaryEntry = doc.data();
                const diaryDiv = document.createElement('div');
                diaryDiv.className = 'card';
                
                const timestamp = new Date(diaryEntry.timestamp).toLocaleString('vi-VN');
                
                diaryDiv.innerHTML = `
                    <div class="card-header p-0 lead" style="cursor: pointer;" ids="${doc.id}">
                        ${timestamp}
                        <!-- <button class="btn btn-sm btn-outline-danger float-end" ids="${doc.id}">
                            Delete
                        </button> -->
                    </div>
                    <div id="diary-${doc.id}" class="collapse">
                        <div class="card-body">
                            <pre>${diaryEntry.content}</pre>
                        </div>
                    </div>
                `;
                
                diariesList.appendChild(diaryDiv);
            });

            // delete button
            document.querySelectorAll("btn.btn-sm.btn-outline-danger.float-end").forEach(function(item){
              item.addEventListener("click", function() {
                event.stopPropagation();
                const docId = this.getAttribute('ids');
                console.log(docId);
                if (!currentUser) return;
                    if (confirm('Are you sure you want to delete this entry?')) {
                        db.collection('users').doc(currentUser.uid).collection('diaries').doc(docId).delete()
                            .catch((e) => {
                                alert('Failed to delete diary entry: ' + e.message);
                            });
                    }
              })
            });

            // toggle card
            document.querySelectorAll(".card-header.p-0.lead").forEach(function(item){
              item.addEventListener("click", function() {
                const docId = this.getAttribute('ids');
                const element = document.getElementById(`diary-${docId}`);
                if (element.classList.contains('show')) {
                    element.classList.remove('show');
                } else {
                    element.classList.add('show');
                }
              })
            });

        }

        function addDiaryEntry() {
            if (!currentUser) return;

            const content = document.getElementById('newone').value.trim();
            if (!content) return;
            
            const diaryEntry = {
                content: content,
                timestamp: new Date().toISOString()
            };
            
            const diaryCollection = db.collection('users').doc(currentUser.uid).collection('diaries');
            diaryCollection.add(diaryEntry)
                .then(() => {
                    document.getElementById('newone').value = '';
                    document.getElementById('add-diary-error').style.display = 'none';
                    writenewone(); // reset textarea height
                })
                .catch((e) => {
                    const errorDiv = document.getElementById('add-diary-error');
                    errorDiv.textContent = 'Failed to save diary entry: ' + e.message;
                    errorDiv.style.display = 'block';
                });
        }

        function toggleDiaryEntry(ele) {
            const docId = ele.currentTarget.ids;
            const element = document.getElementById(`diary-${docId}`);
            if (element.classList.contains('show')) {
                element.classList.remove('show');
            } else {
                element.classList.add('show');
            }
        }

        // UI Helper functions
        function toggleSidebar() {
            document.getElementById('wrapper').classList.toggle('toggled');
        }

        function writenewone() {
            const textarea = document.getElementById('newone');
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Event listeners
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('signup-form').addEventListener('submit', handleSignUp);
        document.getElementById('change-mode-button').addEventListener('click', change_mode);
        document.getElementById('logout-button').addEventListener('click', handleLogout);

        document.getElementById('add-diary-btn').addEventListener('click', addDiaryEntry);
        document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);
        document.getElementById('diary-sidebar').addEventListener('click', showDiary);

        document.getElementById('newone').addEventListener('input', writenewone);
        document.getElementById('newone').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                addDiaryEntry();
            }
        });
    </script>
</body>
</html>